<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        function createDefer() {
            let resolve, reject;
            const promise = new Promise((_resolve, _reject) => {
                resolve = _resolve;
                reject = _reject;
            });
            return {
                promise, resolve, reject
            };
        }
    </script>

    <script>
        const colors = ['green', 'red', 'yellow', 'blue'];

        const factor = 2;
        const RULES = {
            green: {
            green: 0.878214014158254 * factor,
            red: 0.383942932294564 * factor,
            yellow: 0.3632328353781209 * factor,
            blue: 0.4357079645785089 * factor,
            },
            red: {
            green: -0.8131279812066854 * factor,
            red: 0.8761564046567396 * factor,
            yellow: -0.686246916739194 * factor,
            blue: -0.42403398294928163 * factor,
            },
            yellow: {
            green: 0.8283611643992606 * factor,
            red: -0.8050409003234531 * factor,
            yellow: 0.8422661062679588 * factor,
            blue: -0.6206303204367405 * factor,
            },
            blue: {
            green: -0.6276679142294777 * factor,
            red: -0.48726835984229977 * factor,
            yellow: -0.8155039608681607 * factor,
            blue: 0.49503848830455155 * factor,
            },
        };

    </script>

    <script type="module">


        const width = 800;
        const height = 600;
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        document.body.appendChild(canvas);


        const worker = new Worker('./worker.js', {
            type: 'module'
        });


        const ofscreenCanvas = canvas.transferControlToOffscreen();

        (async () => {
            const wordId = await callRemote('createNewParticleWord', [{
                width, height, canvas: ofscreenCanvas, rule: RULES}], [ofscreenCanvas]);

            const taskId = await callRemote('play', [wordId]);
            console.log(wordId, taskId);
        })();



        function callRemote(action, args, transfers = []) {
            const callId = performance.now().toString(32);
            
            const defer = createDefer();
            worker.addEventListener('message', function listener(e) {
                if(!e.data || e.data.callId !== callId) {
                    return 
                }
                if('result' in e.data) {
                    defer.resolve(e.data.result);
                } else {
                    defer.reject(e.data.error);
                }
                window.removeEventListener('message', listener);
            });
            worker.postMessage({
                action, args, callId
            }, {
                transfer: transfers
            });
            return defer.promise;
        }

    </script>
</body>
</html>